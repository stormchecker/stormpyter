import stormpy
import stormvogel

from examples.orchard_game_stormvogel import Orchard, available_actions, delta, labels, rewards, Fruit, GameState

# Build the simple orchard model
def build_simple():
    # Initialize the simple game model
    init_small = Orchard([Fruit.APPLE, Fruit.CHERRY],
                         num_fruits=2, raven_distance=2)
    
    # Build the orchard model
    orchard_simple = stormvogel.bird.build_bird(
        modeltype=stormvogel.ModelType.MDP,
        init=init_small,
        available_actions=available_actions,
        delta=delta,
        labels=labels,
        rewards=rewards,
    )
    return orchard_simple

# Build the full orchard model
def build_full():
    init_game = Orchard([Fruit.APPLE, Fruit.CHERRY, Fruit.PEAR, Fruit.PLUM],
                        num_fruits=4,
                        raven_distance=5)
    
    # For the full model, we only set the relevant labels for the winning conditions
    # and do not expose the internal state information
    def labels_full(state):
        labels = []
        if state.game_state() == GameState.PLAYERS_WON:
            labels.append("PlayersWon")
        elif state.game_state() == GameState.RAVEN_WON:
            labels.append("RavenWon")
        return labels
    
    orchard = stormvogel.bird.build_bird(
        modeltype=stormvogel.ModelType.MDP,
        init=init_game,
        available_actions=available_actions,
        delta=delta,
        labels=labels_full,
        rewards=rewards,
        max_size=100000
    )

    # Convert to stormpy model
    orchard_storm = stormvogel.mapping.stormvogel_to_stormpy(orchard)

    return orchard, orchard_storm

# Build the full orchard model from Prism
def build_prism():
    prism_program = stormpy.parse_prism_program('examples/orchard_stormvogel.pm')
    constants = "NUM_FRUIT=4, DISTANCE_RAVEN=5"
    prism_program = stormpy.preprocess_symbolic_input(prism_program, [], constants)[0].as_prism_program()
    options = stormpy.BuilderOptions()
    options.set_build_state_valuations()
    options.set_build_choice_labels()
    options.set_build_with_choice_origins()
    orchard_prism = stormpy.build_sparse_model_with_options(prism_program, options)
    return orchard_prism